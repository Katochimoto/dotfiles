Actions.add(
    new Action("folder.remove", function(o) {

        var params = o.params;

        var fid = params.id;
        var folder = hFolders.getFolderById(fid);
        var name = Daria.nodeValue(folder, "name");
        var messagesCount = Number(Daria.nodeValue(folder, "count"));

        var allFiltersForFolder = hFilters.getForFolder(name); // все фильтры для папки, включая созданные сборщиками
        var collectorFilters = []; // фильтры, созданные сборщиками
        var userFilters = []; // фильтры, созданные пользователем
        $.each(allFiltersForFolder, function(i, a){
            if(Daria.XML.select(a, 'conditions/item[field="X-yandex-rpop-id"]')) {
                collectorFilters.push(a);
            } else {
                userFilters.push(a);
            }
        });

        var userFiltersCount = userFilters.length;
        var collectorFiltersCount = collectorFilters.length;

        var removeFolder = function(force){
            Handler.doAll(
                [ "do-folder-remove", "folders" ],
                {
                    fid: fid,
                    force: force ? 'yes' : ''
                },
                function(){
                    if(Page.type === "setup"){
                        $(".item-" + fid, bSetupFolders.cache.node).remove();
                        bSetupFolders.foldersList.selectedItem = '';
                        bSetupFolders.foldersList.updateButtons({});
                    }
                }
            );
        };

        // возвращает список фильтров, в кторых используется удаляемая папка
        var getUserFilters = function(){
            var filtersList = [];
            // перечисление всех имён фильтров
            for (var fIndex = 0; fIndex < userFiltersCount; fIndex++) {
                var fAction = userFilters[fIndex];
                filtersList.push('— «<a href="#setup/filters-create/id=' + Daria.nodeValue(fAction, "id") + '">' +
                    Daria.nodeValue(fAction, "rule_name") + '</a>»<br/>');
            }
            return filtersList.join('');
        };

        var confirmBody = [];
        var confirmOk = '';

        if (messagesCount && userFiltersCount) {
            confirmBody.push(Daria.supplant('<p>Папка «{name}» содержит {count} {count:письмо|письма|писем} и используется правил' +
                (userFiltersCount > 1 ? 'ами' : 'ом') + ':</p>', { count: messagesCount, name: name }));

            confirmBody.push(getUserFilters());

            confirmBody.push('<p>Удаление папки также приведет к удалению пис' + (messagesCount > 1 ? 'ем' : 'ьма') +
                ' и правил' + (userFiltersCount > 1 ? '' : 'а') + '. Отредактировать правил' +
                (userFiltersCount > 1 ? 'а' : 'о') + ' можно <a href="#setup/filters">в настройках</a>.</p>');

            confirmOk = 'Удалить папку с письм' + (messagesCount > 1 ? 'ами' : 'ом') + ' и правил' + (userFiltersCount > 1 ? 'а' : 'о');
        }
        else if(messagesCount) {
            confirmBody.push(Daria.supplant('<p>В папке «{name}» {count} {count:письмо|письма|писем}. ' +
                (messagesCount > 1 ? 'Письма будут удалены' : 'Письмо будет удалено') + ' вместе с папкой.</p>',
                {name: name, count: messagesCount}));

            confirmOk = 'Удалить с письм' + (messagesCount > 1 ? 'ами' : 'ом');
        }
        else if (userFiltersCount) {
            confirmBody.push('<p>Эта папка используется правил' + (userFiltersCount > 1 ? 'ами' : 'ом') + ':</p>');

            confirmBody.push(getUserFilters());

            confirmBody.push('<p>Удаление папки также приведет к удалению правил' + (userFiltersCount > 1 ? '' : 'а') +
                '. Назначить для правил' + (userFiltersCount > 1 ? '' : 'а') + ' другую папку можно <a href="#setup/filters">в настройках</a>.</p>');

            confirmOk = 'Удалить папку и правил' + (userFiltersCount > 1 ? 'а' : 'о');
        }

        if (collectorFiltersCount) {
            // Папка используется сборщиком. После удаления папки все письма, собираемые сборщиком, начнут приходить во Входящие. 
//Отредактировать сборщик можно в настройках.
            // Так же папка используется сборщиком. После удаления папки все письма, собираемые сборщиком, начнут приходить во Входящие. Отредактировать сборщик можно в настройках.
            var startOfLine = 'Папка';
            if (messagesCount || userFiltersCount) {
                startOfLine = 'Так же папка'
            } else {
                 confirmOk = 'Удалить папку';
            }
            confirmBody.push('<p>' + startOfLine + ' используется сборщик' + (collectorFiltersCount > 1 ? 'ами' : 'ом')
                + '. После удаления папки все письма, собираемые сборщик' + (collectorFiltersCount > 1 ? 'ами' : 'ом')
                + ', начнут приходить во Входящие. Отредактировать сборщик можно в настройках. <a href="#setup/collectors">в настройках</a>.</p>'); 
        }

        if (messagesCount || userFiltersCount || collectorFiltersCount) {
            Daria.Libs("Daria.Dialog", function() {
                Daria.Dialog.confirm(
                    {
                        title: 'Удаление папки',
                        width: 400,
                        body: confirmBody.join(''),
                        okValue: confirmOk,
                        okHandler: function(){
                            removeFolder(true);
                            if (userFiltersCount) {
                                // папка удалена с фильтрами - нужно почистить кэш фильтров
                                hFilters.clearCache();
                            }
                        }
                    }
                );
            });
        } else {
            removeFolder();
        }
    })
);


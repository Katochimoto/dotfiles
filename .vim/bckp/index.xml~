<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="index.xsl"?>

<page xmlns:xi="http://www.w3.org/2001/XInclude">

    <xscript http-expire-time-delta="0">
        <add-headers>
            <header name="Cache-Control" value="max-age=0, must-revalidate, proxy-revalidate, no-cache, no-store, private"/>
            <header name="Pragma" value="no-cache"/>
        </add-headers>
    </xscript>

    <xi:include href="static/pages/2pane/blue-based/blue/daria/daria.xml"/>

    <js-config><xi:include href="cfg/config.js" parse="text"/></js-config>
    <xi:include href="cfg/config.xml"/>
    <xi:include href="cfg/client-xsl-config.xml"/>
    <xi:include href="cfg/webchat.xml"/>
    <mist method="set_state_by_headers">
        <param type="String"/>
    </mist>
    <lua>
    <![CDATA[
        -- Браузеры, которые не поддерживаются, перебрасываем на lite.xml

        userAgent = xscript.request:getHeader('User-Agent')

        browser = ''
        version = nil

        if userAgent:find('Firefox', 1, true) then
            -- у firefox берем только первую цифру версии
            browser='ff'
            version = userAgent:match('Firefox/(%d+)')

        elseif userAgent:find('Opera', 1, true) then
            browser = 'opera'
            version = userAgent:match('Opera[ /]([%d.]+)')
            if version == '9.80' then
                version = userAgent:match('Version/([%d.]+)')
            end

        elseif userAgent:find('Netscape', 1, true) then
            browser = 'netscape'

        elseif userAgent:find('Konqueror', 1, true) then
            browser = 'konqueror'

        elseif userAgent:find('Safari', 1, true) then
            browser = 'safari'
            version = userAgent:match('Version/([%d.]+)')
            if not(version) then
                version = userAgent:match('Safari/([%d.]+)')
                if(version) then
                    if tonumber(version) < 500 then
                        version = '2'
                    end
                end
            end
        end

        if version then
            version = tonumber(string.gsub(version,'[^%d]',''),10)
        end

        if browser == 'netscape' or browser == 'konqueror' or
           (version and (
                (browser == 'opera' and version <= 927) or
                (browser == 'ff' and version < 2 ) or
                (browser == 'safari' and version < 3 ))) then

           xscript.response:redirectToPath('/neo2/lite.xml')
        end
    ]]>
    </lua>

    <lua>
    <![CDATA[
        if (xscript.request:getArg('no-xslt') == 'yes') then
            xscript.dropStylesheet()
        end

        xscript.state:setString('handler.settings', 'true')
        xscript.state:setString('handler.account-information', 'true')
        xscript.state:setString('handler.debug-settings', 'true')
    ]]>
    </lua>

    <xi:include href="browser-updater.xml" />

    <file method="invoke" timeout="30000">
        <param type="String">handlers/handlers.xml</param>
        <xpointer>/handlers/handler/*</xpointer>
    </file>

    <color-themes>
        <xi:include href="handlers/settings/settings-color-schemes.xml" xpointer="xpointer(/handler/settings-color-schemes/color-theme)"/>
    </color-themes>

</page>

